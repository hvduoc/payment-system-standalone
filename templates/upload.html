{% extends "layout.html" %}
{% block title %}Trang ch·ªß ¬∑ Upload CSV{% endblock %}

{% block extra_head %}
<style>
  /* L∆∞·ªõi g·ªçn cho form t·∫£i CSV */
  .dl-grid{
    display:grid;
    grid-template-columns:repeat(12, minmax(0,1fr));
    gap:12px 16px; align-items:end;
  }
  .dl-grid > label{
    display:flex; flex-direction:column; gap:6px; grid-column:span 6;
  }
  @media (min-width:768px){ .dl-grid > label{ grid-column:span 3; } }
  .dl-grid input[type="number"]{ width:100%; }
</style>
{% endblock %}

{% block content %}

<h1>C·∫≠p nh·∫≠t d·ªØ li·ªáu t·ª´ CSV</h1>

{% if ingest_last or ingest_next %}
<div class="card" style="margin:10px 0 18px; padding:12px; border:1px solid var(--line);">
  <div style="font-weight:600; margin-bottom:6px">Tr·∫°ng th√°i ƒë·ªìng b·ªô</div>
  <div>
    L·∫ßn c·∫≠p nh·∫≠t g·∫ßn nh·∫•t:
    <strong>{{ ingest_last.finished_at | vn_dt if ingest_last else '‚Äî' }}</strong>
    {% if ingest_last %}
      ¬∑ <span class="muted">+{{ ingest_last.rows_inserted }} m·ªõi, {{ ingest_last.rows_updated }} c·∫≠p nh·∫≠t</span>
    {% endif %}
  </div>
  <div>
    L·∫ßn ch·∫°y ti·∫øp theo (d·ª± ki·∫øn):
    <strong>
      {% if ingest_next %}{{ ingest_next.astimezone() | vn_dt }}{% else %}‚Äî{% endif %}
    </strong>
  </div>
</div>
{% endif %}

<p class="muted">T·∫£i file <code>reservations.csv</code> xu·∫•t t·ª´ Airbnb ƒë·ªÉ c·∫≠p nh·∫≠t/ƒë·ªìng b·ªô d·ªØ li·ªáu.</p>

<!-- ===== T·∫¢I CSV AIRBNB THEO S·ªê TRANG ===== -->
<!-- ===== T·∫¢I CSV T·ª™ AIRBNB ===== -->
<h2 style="margin:18px 0 8px; font-size:20px">T·∫£i CSV t·ª´ Airbnb</h2>

<form action="/airbnb/csv-link" method="get" target="_blank" class="dl-grid" style="margin-bottom:10px">
  <label>
    Trang:
    <input id="page_single" type="number" name="page" min="1" value="1" required>
  </label>
  <label>
    M·ªói trang:
    <input id="limit" type="number" name="limit" min="1" max="200" value="40">
  </label>

  <div style="grid-column:1 / -1; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
    <button class="btn btn-blue" type="submit">‚¨áÔ∏è T·∫£i 1 trang</button>
    <button class="btn btn-ghost" type="button" id="btnMany">‚¨áÔ∏è T·∫£i nhi·ªÅu trang</button>
    <button class="btn" type="button" id="btnManyZip">‚¨áÔ∏è T·∫£i nhi·ªÅu (ZIP)</button>
    <script>
    document.getElementById('btnManyZip').addEventListener('click', ()=>{
      const from  = parseInt(document.getElementById('page_from').value || '1', 10);
      const to    = parseInt(document.getElementById('page_to').value   || String(from), 10);
      const limit = parseInt(document.getElementById('limit').value     || '40', 10);
      if (isNaN(from) || isNaN(to) || from < 1 || to < from) { alert('Kho·∫£ng trang kh√¥ng h·ª£p l·ªá'); return; }
      window.location.href = `/airbnb/csv-batch?page_from=${from}&page_to=${to}&limit=${limit}`;
    });
    </script>


    <!-- Preview URL ƒë·ªÉ b·∫•m m·ªü tr·ª±c ti·∫øp -->
    <span class="muted">| </span>
    <a id="previewLink" class="nav-link" href="#" target="_blank">Xem URL trang hi·ªán t·∫°i</a>
  </div>
</form>

<div class="dl-grid" style="margin-top:0">
  <label>
    T·ª´ trang:
    <input id="page_from" type="number" min="1" value="1">
  </label>
  <label>
    ƒê·∫øn trang:
    <input id="page_to" type="number" min="1" value="5">
  </label>
</div>

<p class="muted" style="margin:6px 0 18px">
  ‚ÄúT·∫£i 1 trang‚Äù m·ªü tab m·ªõi t·ªõi Airbnb ƒë·ªÉ t·∫£i (c·∫ßn ƒëang ƒëƒÉng nh·∫≠p). ‚ÄúT·∫£i nhi·ªÅu trang‚Äù t·∫£i tu·∫ßn t·ª± b·∫±ng iframe ·∫©n (kh√¥ng b·ªã ch·∫∑n pop-up).
</p>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // build URL g·ªëc Airbnb (ƒë·ªÉ preview)
  function buildAirbnbUrl(page, limit){
    const offset = (page - 1) * limit;
    const base = "https://www.airbnb.com.vn/api/v2/download_reservations";
    const params = new URLSearchParams({
      _format: "for_remy",
      _limit: String(limit),
      _offset: String(offset),
      collection_strategy: "for_reservations_list",
      sort_field: "start_date",
      sort_order: "desc",
      status: "accepted,request,canceled",
      page: String(page),
      key: "d306zoyjsyarp7ifhu67rjxn52tv0t20",
      currency: "VND",
      locale: "vi",
    });
    // gi·ªØ d·∫•u ph·∫©y trong 'status'
    return `${base}?${params.toString().replaceAll('%2C', ',')}`;
  }

  function updatePreview(){
    const page  = parseInt($('page_single').value || '1', 10);
    const limit = parseInt($('limit').value || '40', 10);
    $('previewLink').href = buildAirbnbUrl(page, limit);
  }
  $('page_single').addEventListener('input', updatePreview);
  $('limit').addEventListener('input', updatePreview);
  updatePreview();

  // T·∫£i nhi·ªÅu trang b·∫±ng iframe ·∫©n (kh√¥ng pop-up)
  $('btnMany').addEventListener('click', function(){
    const from  = parseInt($('page_from').value || '1', 10);
    const to    = parseInt($('page_to').value   || String(from), 10);
    const limit = parseInt($('limit').value     || '40', 10);
    if (isNaN(from) || isNaN(to) || from < 1 || to < from) {
      alert('Kho·∫£ng trang kh√¥ng h·ª£p l·ªá'); return;
    }
    let iframe = $('dl_iframe');
    if (!iframe) {
      iframe = document.createElement('iframe');
      iframe.id = 'dl_iframe'; iframe.style.display = 'none';
      document.body.appendChild(iframe);
    }
    const delayMs = 1200; // gi√£n c√°ch cho ch·∫Øc
    let p = from;
    (function next(){
      if (p > to) return;
      // d√πng route server ƒë·ªÉ redirect (gi·ªØ cookie ƒëƒÉng nh·∫≠p ·ªü domain Airbnb)
      iframe.src = `/airbnb/csv-link?page=${p}&limit=${limit}`;
      p += 1;
      setTimeout(next, delayMs);
    })();
  });
})();

// ===== ROOM MAPPING JAVASCRIPT =====
const AVAILABLE_PROPERTIES = []; // Will be populated by backend

function loadProperties() {
  fetch('/api/properties')
    .then(response => response.json())
    .then(properties => {
      AVAILABLE_PROPERTIES.length = 0;
      properties.forEach(prop => {
        AVAILABLE_PROPERTIES.push({
          code: prop.property_short || prop.property_name || `PROP-${prop.id}`,
          name: prop.property_name,
          id: prop.id
        });
      });
      updateAllPropertySelects();
    })
    .catch(error => console.error('L·ªói t·∫£i danh s√°ch ph√≤ng:', error));
}

function updateAllPropertySelects() {
  document.querySelectorAll('.mapping-rule select').forEach(select => {
    updatePropertySelect(select);
  });
}

function updatePropertySelect(select) {
  const currentValue = select.value;
  select.innerHTML = '<option value="">Ch·ªçn m√£ ph√≤ng n·ªôi b·ªô</option>';
  
  AVAILABLE_PROPERTIES.forEach(prop => {
    const option = document.createElement('option');
    option.value = prop.code;
    option.textContent = `${prop.code} - ${prop.name}`;
    if (prop.code === currentValue) {
      option.selected = true;
    }
    select.appendChild(option);
  });
}

function addMapping() {
  const container = document.getElementById('room-mapping-container');
  const newRule = document.createElement('div');
  newRule.className = 'mapping-rule';
  newRule.style.cssText = 'display:flex; gap:8px; margin:6px 0; align-items:center';
  
  newRule.innerHTML = `
    <input type="text" placeholder="T√™n ph√≤ng trong CSV" style="flex:1; padding:6px 8px; border:1px solid #ddd; border-radius:4px">
    <span>‚Üí</span>
    <select style="flex:0 0 200px; padding:6px 8px; border:1px solid #ddd; border-radius:4px">
      <option value="">Ch·ªçn m√£ ph√≤ng n·ªôi b·ªô</option>
    </select>
    <button type="button" class="btn-remove" onclick="removeMapping(this)" style="background:#ff4444; color:white; border:none; padding:4px 8px; border-radius:4px">X√≥a</button>
  `;
  
  container.appendChild(newRule);
  updatePropertySelect(newRule.querySelector('select'));
}

function removeMapping(btn) {
  btn.parentElement.remove();
}

function collectMappingData() {
  const mappings = {};
  document.querySelectorAll('.mapping-rule').forEach(rule => {
    const input = rule.querySelector('input[type="text"]');
    const select = rule.querySelector('select');
    if (input.value.trim() && select.value.trim()) {
      mappings[input.value.trim()] = select.value.trim();
    }
  });
  return mappings;
}

// Update hidden field before form submission
document.querySelector('form[action="/upload"]').addEventListener('submit', function(e) {
  const useMapping = document.getElementById('use_room_mapping').checked;
  if (useMapping) {
    const mappingData = collectMappingData();
    document.getElementById('room_mapping_data').value = JSON.stringify(mappingData);
  }
});

// Preview CSV with room mapping
async function previewCSV() {
  const filesInput = document.getElementById('csv_files');
  const useMapping = document.getElementById('use_room_mapping').checked;
  
  if (!filesInput.files.length) {
    alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 file CSV');
    return;
  }
  
  const formData = new FormData();
  for (let i = 0; i < filesInput.files.length; i++) {
    formData.append('files', filesInput.files[i]);
  }
  
  if (useMapping) {
    const mappingData = collectMappingData();
    formData.append('room_mapping', JSON.stringify(mappingData));
  }
  
  try {
    showPreviewLoading();
    
    const response = await fetch('/api/csv/preview', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      displayPreviewResults(result.data);
    } else {
      alert('L·ªói preview: ' + result.error);
    }
    
    hidePreviewLoading();
  } catch (error) {
    hidePreviewLoading();
    alert('L·ªói k·∫øt n·ªëi: ' + error.message);
  }
}

function showPreviewLoading() {
  const previewDiv = document.getElementById('csv_preview_results');
  const contentDiv = document.getElementById('preview_content');
  
  contentDiv.innerHTML = '<div style="text-align:center; padding:20px">üîÑ ƒêang x·ª≠ l√Ω preview...</div>';
  previewDiv.style.display = 'block';
}

function hidePreviewLoading() {
  // Do nothing, keep showing results
}

function displayPreviewResults(data) {
  const contentDiv = document.getElementById('preview_content');
  
  let html = '';
  data.forEach((fileData, index) => {
    html += `<div class="card" style="margin:10px 0; padding:16px; border:1px solid var(--line)">`;
    html += `<h4>üìÑ ${fileData.filename}</h4>`;
    
    if (fileData.preview && fileData.preview.length > 0) {
      html += `<table style="width:100%; border-collapse:collapse; margin:10px 0">`;
      html += `<thead><tr style="background:#f8f9fa">`;
      html += `<th style="padding:8px; border:1px solid #ddd">T√™n ph√≤ng g·ªëc</th>`;
      html += `<th style="padding:8px; border:1px solid #ddd">T√™n ph√≤ng sau mapping</th>`;
      html += `<th style="padding:8px; border:1px solid #ddd">Tr·∫°ng th√°i</th>`;
      html += `</tr></thead><tbody>`;
      
      fileData.preview.forEach(row => {
        const statusColor = row.mapped ? 'green' : 'orange';
        const statusText = row.mapped ? '‚úÖ ƒê√£ mapping' : '‚ö†Ô∏è Gi·ªØ nguy√™n';
        
        html += `<tr>`;
        html += `<td style="padding:8px; border:1px solid #ddd">${row.original || '-'}</td>`;
        html += `<td style="padding:8px; border:1px solid #ddd; font-weight:bold">${row.mapped_name || row.original || '-'}</td>`;
        html += `<td style="padding:8px; border:1px solid #ddd; color:${statusColor}">${statusText}</td>`;
        html += `</tr>`;
      });
      
      html += `</tbody></table>`;
    } else {
      html += `<p class="muted">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu listing trong file n√†y</p>`;
    }
    
    html += `</div>`;
  });
  
  contentDiv.innerHTML = html;
}

// Load properties on page load
document.addEventListener('DOMContentLoaded', function() {
  loadProperties();
});
</script>
<!-- ===== /T·∫¢I CSV T·ª™ AIRBNB ===== -->


<!-- ===== /T·∫¢I CSV AIRBNB ===== -->

<!-- FORM UPLOAD CSV V·ªöI ROOM MAPPING -->
<h2 style="margin:18px 0 8px; font-size:20px">Upload CSV v·ªõi mapping ph√≤ng</h2>

<!-- Room Mapping Configuration -->
<div class="card" style="margin:10px 0; padding:16px; border:1px solid var(--line); background:#f8f9fa;">
  <h3 style="margin:0 0 12px; font-size:16px">‚öôÔ∏è C·∫•u h√¨nh mapping t√™n ph√≤ng</h3>
  <p class="muted" style="margin:0 0 12px">ƒê·ªãnh nghƒ©a t∆∞∆°ng ·ª©ng gi·ªØa t√™n ph√≤ng trong CSV Airbnb v√† m√£ ph√≤ng n·ªôi b·ªô:</p>
  
  <div id="room-mapping-container">
    <div class="mapping-rule" style="display:flex; gap:8px; margin:6px 0; align-items:center">
      <input type="text" placeholder="T√™n ph√≤ng trong CSV" style="flex:1; padding:6px 8px; border:1px solid #ddd; border-radius:4px">
      <span>‚Üí</span>
      <select style="flex:0 0 200px; padding:6px 8px; border:1px solid #ddd; border-radius:4px">
        <option value="">Ch·ªçn m√£ ph√≤ng n·ªôi b·ªô</option>
        <!-- Will be populated by JavaScript -->
      </select>
      <button type="button" class="btn-remove" onclick="removeMapping(this)" style="background:#ff4444; color:white; border:none; padding:4px 8px; border-radius:4px">X√≥a</button>
    </div>
  </div>
  
  <button type="button" onclick="addMapping()" style="margin:8px 0; background:#28a745; color:white; border:none; padding:6px 12px; border-radius:4px">‚ûï Th√™m mapping</button>
  
  <div style="margin:12px 0 0">
    <strong>Mapping m·∫´u:</strong>
    <div class="muted" style="font-size:13px; margin:4px 0">
      ‚Ä¢ "Deluxe Ocean View" ‚Üí "AVA-301"<br>
      ‚Ä¢ "Standard City View" ‚Üí "AVA-201"<br>
      ‚Ä¢ "Premium Suite 5th Floor" ‚Üí "AVA-502"
    </div>
  </div>
</div>

<form action="/upload" method="post" enctype="multipart/form-data" style="margin:16px 0;">
  <div style="display:flex; gap:10px; align-items:center; margin:12px 0">
    <input type="file" name="files" multiple accept=".csv,text/csv" id="csv_files">
    <label style="display:flex; align-items:center; gap:6px">
      <input type="checkbox" name="use_room_mapping" value="1" checked id="use_room_mapping">
      √Åp d·ª•ng room mapping
    </label>
  </div>
  
  <!-- Hidden field to store mapping data -->
  <input type="hidden" name="room_mapping" id="room_mapping_data">
  
  <div style="display:flex; gap:10px; margin:12px 0">
    <button class="btn btn-blue" type="button" onclick="previewCSV()">üëÅÔ∏è Preview CSV</button>
    <button class="btn btn-green" type="submit">‚¨ÜÔ∏è T·∫£i l√™n & C·∫≠p nh·∫≠t</button>
  </div>
</form>

<!-- CSV Preview Results -->
<div id="csv_preview_results" style="margin:20px 0; display:none">
  <h3>üìã Preview CSV v·ªõi Room Mapping</h3>
  <div id="preview_content"></div>
</div>
<p class="muted" style="margin:6px 0">M·∫πo: c√≥ th·ªÉ ch·ªçn nhi·ªÅu file CSV m·ªôt l√∫c (gi·ªØ Ctrl/Shift khi ch·ªçn).</p>


{% if msg %}
  <div class="card" style="margin:15px 0; padding:12px; border:1px solid {% if success %}#28a745{% else %}#dc3545{% endif %}; background:{% if success %}#f8fff8{% else %}#fff5f5{% endif %};">
    <div style="white-space: pre-line;">{{ msg }}</div>
    {% if upload_stats %}
      <div style="margin-top:8px; font-size:0.9em; color:#666;">
        <small>
          üìà Chi ti·∫øt: {{ upload_stats.inserted or 0 }} th√™m m·ªõi + {{ upload_stats.updated or 0 }} c·∫≠p nh·∫≠t
          {% if upload_stats.processing_time %}
            | ‚ö° {{ "%.2f"|format(upload_stats.processing_time) }}s
          {% endif %}
        </small>
      </div>
    {% endif %}
  </div>
{% endif %}

<p>
  <a href="/bookings">Xem danh s√°ch ƒë·∫∑t ph√≤ng</a> ¬∑
  <a href="/reports/monthly">B√°o c√°o theo th√°ng</a>
</p>

{% endblock %}
