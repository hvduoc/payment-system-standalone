<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Thu Chi Airbnb - Full Featured</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .role-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .role-assistant { background-color: #dbeafe; color: #1e40af; }
        .role-manager { background-color: #fef3c7; color: #d97706; }
        .role-owner { background-color: #ecfdf5; color: #059669; }
        .receipt-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        .handover-card {
            border-left: 4px solid #10b981;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>
                    Hệ thống Thu Chi Airbnb
                    <span class="text-sm text-green-600 font-normal ml-2">v2.0 Production</span>
                </h1>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="currentTime"></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-700" id="currentUser">{{ user.full_name if user else 'Loading...' }}</span>
                        <span id="userRole" class="role-badge role-{{ user.role if user else 'unknown' }}">
                            {{ getRoleDisplayName(user.role) if user else 'Unknown' }}
                        </span>
                    </div>
                    <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800">
                        <i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Navigation Tabs -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8">
                <button onclick="showTab('dashboard')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-green-500 text-green-600" data-tab="dashboard">
                    <i class="fas fa-chart-line mr-2"></i>Tổng quan
                </button>
                <button onclick="showTab('add-payment')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="add-payment">
                    <i class="fas fa-plus-circle mr-2"></i>Ghi nhận thu
                </button>
                <button onclick="showTab('handover')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="handover">
                    <i class="fas fa-handshake mr-2"></i>Bàn giao
                </button>
                <button onclick="showTab('payments-list')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="payments-list">
                    <i class="fas fa-list mr-2"></i>Lịch sử thu
                </button>
                <button onclick="showTab('handover-list')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="handover-list">
                    <i class="fas fa-history mr-2"></i>Lịch sử bàn giao
                </button>
                <button onclick="showTab('team')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="team" id="teamTab">
                    <i class="fas fa-users mr-2"></i>Đội ngũ
                </button>
            </nav>
        </div>

        <!-- Tab Tổng quan -->
        <div id="dashboard-tab" class="tab-content">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-lg">
                            <i class="fas fa-money-bill text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Tổng thu</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalCollected">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i class="fas fa-percentage text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Tỷ lệ thu</p>
                            <p class="text-2xl font-semibold text-gray-900" id="collectionRate">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-lg">
                            <i class="fas fa-wallet text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Tiền mặt cần bàn giao</p>
                            <p class="text-2xl font-semibold text-gray-900" id="cashPending">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-purple-100 rounded-lg">
                            <i class="fas fa-handshake text-purple-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Số lần bàn giao</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalHandovers">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Message -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-8">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-600 mr-3"></i>
                    <div>
                        <h3 class="text-sm font-medium text-green-800">✅ Hệ thống hoạt động bình thường!</h3>
                        <p class="text-sm text-green-700">
                            Chào mừng <strong>{{ user.full_name if user else 'User' }}</strong>! 
                            Database SQLite bền vững đã được kết nối thành công.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Ghi nhận thu -->
        <div id="add-payment-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-6">Ghi nhận khoản thu mới</h2>
                <form id="paymentForm" class="space-y-6" enctype="multipart/form-data">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Mã booking <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="bookingId" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tên khách <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="guestName" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Số tiền phải thu (VNĐ) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="amountDue" required min="0"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Số tiền đã thu (VNĐ) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="amountCollected" required min="0"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Phương thức thanh toán <span class="text-red-500">*</span>
                            </label>
                            <select id="paymentMethod" required
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Chọn phương thức</option>
                                <option value="cash">Tiền mặt</option>
                                <option value="bank_transfer">Chuyển khoản ngân hàng</option>
                                <option value="airbnb_payout">Thanh toán Airbnb</option>
                                <option value="momo">Ví MoMo</option>
                                <option value="zalopay">Ví ZaloPay</option>
                                <option value="vnpay">Ví VNPay</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Người thu <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="collectedBy" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Hình ảnh biên lai/chứng từ
                            </label>
                            <input type="file" id="receiptImage" accept="image/*"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">Chọn hình ảnh biên lai, chuyển khoản hoặc chứng từ thu (JPG, PNG)</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ghi chú
                            </label>
                            <textarea id="notes" rows="3"
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                      placeholder="Thêm ghi chú về khoản thu này..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="resetPaymentForm()"
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Xóa form
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-save mr-2"></i>Lưu khoản thu
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab Bàn giao -->
        <div id="handover-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-6">Bàn giao tiền mặt</h2>
                <form id="handoverForm" class="space-y-6" enctype="multipart/form-data">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Người nhận <span class="text-red-500">*</span>
                            </label>
                            <select id="recipientId" required
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Chọn người nhận</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Số tiền bàn giao (VNĐ) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="handoverAmount" required min="0"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Hình ảnh bàn giao
                            </label>
                            <input type="file" id="handoverImage" accept="image/*"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">Chụp ảnh quá trình bàn giao, chữ ký xác nhận (JPG, PNG)</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ghi chú bàn giao
                            </label>
                            <textarea id="handoverNotes" rows="3"
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                      placeholder="Ghi chú về việc bàn giao..."></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                            <div>
                                <h3 class="text-sm font-medium text-yellow-800">Lưu ý quan trọng</h3>
                                <p class="text-sm text-yellow-700">Vui lòng kiểm tra kỹ số tiền và chụp ảnh xác nhận trước khi hoàn tất bàn giao.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="resetHandoverForm()"
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Xóa form
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-handshake mr-2"></i>Xác nhận bàn giao
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab Lịch sử thu -->
        <div id="payments-list-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold">Lịch sử khoản thu</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thời gian</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã booking</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khách</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phải thu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Đã thu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phương thức</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Người thu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hình ảnh</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu sẽ được load ở đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Lịch sử bàn giao -->
        <div id="handover-list-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold">Lịch sử bàn giao</h2>
                </div>
                
                <div id="handoverListContainer" class="p-6">
                    <!-- Danh sách bàn giao sẽ được load ở đây -->
                </div>
            </div>
        </div>

        <!-- Tab Đội ngũ -->
        <div id="team-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold">Danh sách đội ngũ</h2>
                </div>
                
                <div id="teamListContainer" class="p-6">
                    <!-- Danh sách team sẽ được load ở đây -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Thông báo -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i id="toastIcon" class="text-xl"></i>
                </div>
                <div class="ml-3">
                    <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xem hình ảnh -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl max-h-screen p-4">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-2xl z-10">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Hình ảnh" class="max-w-full max-h-full object-contain">
        </div>
    </div>

    <script>
        // Set current user from server
        window.currentUser = {{ user | tojson if user else '{}' }};
        let recipients = [];
        let teamMembers = [];
        
        console.log('Current user from server:', window.currentUser);

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateClock();
            setInterval(updateClock, 1000);
            loadDashboard();
            loadRecipients();
            loadTeamMembers();
        });

        // Update clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleString('vi-VN');
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'text-green-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-green-500', 'text-green-600');
            
            if (tabName === 'payments-list') {
                loadPayments();
            } else if (tabName === 'handover-list') {
                loadHandovers();
            } else if (tabName === 'team') {
                displayTeamMembers();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            }
        }

        // Load dashboard
        async function loadDashboard() {
            try {
                const response = await axios.get('/api/dashboard');
                const data = response.data;
                
                document.getElementById('totalCollected').textContent = formatCurrency(data.total_collected);
                document.getElementById('collectionRate').textContent = `${data.collection_rate}%`;
                document.getElementById('cashPending').textContent = formatCurrency(data.cash_pending_handover);
                document.getElementById('totalHandovers').textContent = data.total_handovers;
                
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                if (error.response?.status === 401) {
                    window.location.href = '/login';
                }
            }
        }

        // Load recipients
        async function loadRecipients() {
            try {
                const response = await axios.get('/api/recipients');
                recipients = response.data.recipients;
                
                const select = document.getElementById('recipientId');
                if (select) {
                    select.innerHTML = '<option value="">Chọn người nhận</option>';
                    
                    recipients.forEach(recipient => {
                        const option = document.createElement('option');
                        option.value = recipient.id;
                        option.textContent = `${recipient.name} - ${recipient.role} (${recipient.phone})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load recipients:', error);
            }
        }

        // Load team members
        async function loadTeamMembers() {
            try {
                const response = await axios.get('/api/users');
                teamMembers = response.data.users;
            } catch (error) {
                console.error('Failed to load team members:', error);
                const teamTab = document.getElementById('teamTab');
                if (teamTab && error.response?.status === 403) {
                    teamTab.style.display = 'none';
                }
            }
        }

        // Display team members
        function displayTeamMembers() {
            const container = document.getElementById('teamListContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Không có quyền xem danh sách team</p>';
                return;
            }
            
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
            
            teamMembers.forEach(member => {
                const card = document.createElement('div');
                card.className = 'bg-white border rounded-lg p-4 hover:shadow-md transition-shadow';
                
                const roleClass = `role-${member.role}`;
                
                card.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                <i class="fas fa-user text-gray-600"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">
                                ${member.full_name}
                            </p>
                            <p class="text-sm text-gray-500 truncate">
                                @${member.username}
                            </p>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="role-badge ${roleClass}">
                                ${member.role_display}
                            </span>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-600">
                        ${member.phone ? `<p><i class="fas fa-phone mr-2"></i>${member.phone}</p>` : ''}
                        ${member.email ? `<p><i class="fas fa-envelope mr-2"></i>${member.email}</p>` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            container.appendChild(grid);
        }

        // Payment form submission
        document.getElementById('paymentForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('booking_id', document.getElementById('bookingId').value);
            formData.append('guest_name', document.getElementById('guestName').value);
            formData.append('amount_due', document.getElementById('amountDue').value);
            formData.append('amount_collected', document.getElementById('amountCollected').value);
            formData.append('payment_method', document.getElementById('paymentMethod').value);
            formData.append('collected_by', document.getElementById('collectedBy').value);
            formData.append('notes', document.getElementById('notes').value);
            
            const receiptImage = document.getElementById('receiptImage')?.files[0];
            if (receiptImage) {
                formData.append('receipt_image', receiptImage);
            }
            
            try {
                const response = await axios.post('/api/payments', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                if (response.data.success) {
                    showToast('Đã lưu khoản thu thành công!', 'success');
                    resetPaymentForm();
                    await loadDashboard();
                }
                
            } catch (error) {
                console.error('Payment submission error:', error);
                if (error.response?.status === 401) {
                    showToast('Phiên đăng nhập đã hết hạn', 'error');
                    setTimeout(() => window.location.href = '/login', 2000);
                } else {
                    showToast('Không thể lưu khoản thu', 'error');
                }
            }
        });

        // Handover form submission
        document.getElementById('handoverForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('recipient_user_id', document.getElementById('recipientId').value);
            formData.append('amount', document.getElementById('handoverAmount').value);
            formData.append('notes', document.getElementById('handoverNotes').value);
            
            const handoverImage = document.getElementById('handoverImage')?.files[0];
            if (handoverImage) {
                formData.append('handover_image', handoverImage);
            }
            
            try {
                const response = await axios.post('/api/handovers', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                if (response.data.success) {
                    showToast('Đã bàn giao thành công!', 'success');
                    resetHandoverForm();
                    await loadDashboard();
                }
                
            } catch (error) {
                console.error('Handover submission error:', error);
                if (error.response?.status === 401) {
                    showToast('Phiên đăng nhập đã hết hạn', 'error');
                    setTimeout(() => window.location.href = '/login', 2000);
                } else {
                    showToast('Không thể thực hiện bàn giao', 'error');
                }
            }
        });

        // Load payments
        async function loadPayments() {
            try {
                const response = await axios.get('/api/payments');
                const payments = response.data.payments;
                
                const tbody = document.getElementById('paymentsTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (payments.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                Chưa có khoản thu nào
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                payments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatDateTime(payment.timestamp)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${payment.booking_id}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${payment.guest_name}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatCurrency(payment.amount_due)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatCurrency(payment.amount_collected)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${getPaymentMethodText(payment.payment_method)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${payment.collected_by}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${payment.receipt_image ? 
                                `<button onclick="showImage('${payment.receipt_image}')" class="text-green-600 hover:text-green-800">
                                    <i class="fas fa-image"></i> Xem ảnh
                                </button>` : 
                                '<span class="text-gray-400">Không có</span>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Failed to load payments:', error);
                if (error.response?.status === 401) {
                    window.location.href = '/login';
                }
            }
        }

        // Load handovers
        async function loadHandovers() {
            try {
                const response = await axios.get('/api/handovers');
                const handovers = response.data.handovers;
                
                const container = document.getElementById('handoverListContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (handovers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Chưa có bàn giao nào</p>';
                    return;
                }
                
                handovers.forEach(handover => {
                    const card = document.createElement('div');
                    card.className = 'handover-card bg-white border rounded-lg p-4 mb-4';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-semibold text-lg">Bàn giao #${handover.id}</h3>
                                <p class="text-gray-600">${formatDateTime(handover.timestamp)}</p>
                            </div>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">
                                ${handover.status === 'completed' ? 'Hoàn thành' : 'Đang xử lý'}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <p class="text-sm text-gray-600">Người bàn giao:</p>
                                <p class="font-medium">${handover.handover_by}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Người nhận:</p>
                                <p class="font-medium">${handover.recipient_name}</p>
                                <p class="text-sm text-gray-500">${handover.recipient_phone}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Số tiền:</p>
                                <p class="font-bold text-lg text-green-600">${formatCurrency(handover.amount)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Trạng thái ký nhận:</p>
                                <p class="font-medium ${handover.signature_status === 'signed' ? 'text-green-600' : 'text-yellow-600'}">
                                    ${handover.signature_status === 'signed' ? 'Đã ký nhận' : 'Chờ ký nhận'}
                                </p>
                            </div>
                        </div>
                        
                        ${handover.notes ? `
                            <div class="mb-3">
                                <p class="text-sm text-gray-600">Ghi chú:</p>
                                <p class="text-sm">${handover.notes}</p>
                            </div>
                        ` : ''}
                        
                        ${handover.handover_image ? `
                            <div class="mb-3">
                                <button onclick="showImage('${handover.handover_image}')" 
                                        class="text-green-600 hover:text-green-800 text-sm">
                                    <i class="fas fa-image mr-1"></i> Xem hình ảnh bàn giao
                                </button>
                            </div>
                        ` : ''}
                    `;
                    container.appendChild(card);
                });
                
            } catch (error) {
                console.error('Failed to load handovers:', error);
                if (error.response?.status === 401) {
                    window.location.href = '/login';
                }
            }
        }

        // Form reset functions
        function resetPaymentForm() {
            document.getElementById('paymentForm')?.reset();
        }

        function resetHandoverForm() {
            document.getElementById('handoverForm')?.reset();
        }

        // Image modal functions
        function showImage(imagePath) {
            document.getElementById('modalImage').src = imagePath;
            document.getElementById('imageModal').classList.remove('hidden');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        // Logout
        async function logout() {
            try {
                await axios.post('/api/logout');
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN');
        }

        function getPaymentMethodText(method) {
            const methods = {
                'cash': 'Tiền mặt',
                'bank_transfer': 'Chuyển khoản',
                'airbnb_payout': 'Airbnb',
                'momo': 'MoMo',
                'zalopay': 'ZaloPay',
                'vnpay': 'VNPay'
            };
            return methods[method] || method;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            if (!toast || !icon || !messageEl) return;
            
            messageEl.textContent = message;
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle text-green-500 text-xl';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle text-red-500 text-xl';
            } else {
                icon.className = 'fas fa-info-circle text-blue-500 text-xl';
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                hideToast();
            }, 5000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.classList.add('hidden');
            }
        }

        // Close modal when clicking outside
        document.getElementById('imageModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
    </script>
</body>
</html>