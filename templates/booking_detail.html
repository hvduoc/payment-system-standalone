{% extends "layout.html" %}
{% block content %}
<h1>Chi tiáº¿t Ä‘áº·t phÃ²ng</h1>
<p class="muted"><a href="/bookings">â† Quay láº¡i danh sÃ¡ch</a></p>

<!-- Basic Booking Information -->
<h2>ThÃ´ng tin cÆ¡ báº£n</h2>
<table>
  <tr><th>MÃ£ xÃ¡c nháº­n</th><td>{{ b.confirmation_code }}</td></tr>
  <tr><th>Listing</th><td>{{ b.listing_raw }}</td></tr>
  <tr><th>TÃ²a nhÃ </th><td>{{ b.building_name or 'â€”' }}</td></tr>
  <tr><th>CÄƒn (unit)</th><td>{{ b.unit_number or 'â€”' }} Â· MÃ£: {{ b.unit_short or 'â€”' }}</td></tr>
  <tr><th>MÃ£ cÄƒn (ngáº¯n)</th><td>{{ b.property_short or 'â€”' }}</td></tr>
  <tr><th>NgÃ y Ä‘áº·t</th><td>{{ b.booking_date }}</td></tr>
  <tr><th>Báº¯t Ä‘áº§u</th><td>{{ b.start_date }}</td></tr>
  <tr><th>Káº¿t thÃºc</th><td>{{ b.end_date }}</td></tr>
  <tr><th>Sá»‘ Ä‘Ãªm</th><td>{{ b.num_nights }}</td></tr>
  <tr><th>KhÃ¡ch</th><td>{{ b.guest_name }}</td></tr>
  <tr><th>LiÃªn há»‡</th><td>{{ b.guest_contact }}</td></tr>
  <tr><th>NgÆ°á»i lá»›n / Tráº» / Em bÃ©</th><td>{{ b.num_adults or 0 }} / {{ b.num_children or 0 }} / {{ b.num_infants or 0 }}</td></tr>
  <tr><th>Tráº¡ng thÃ¡i</th><td>{{ b.status }}</td></tr>
  <tr><th>Thu nháº­p (VND)</th><td>{{ "{:,}".format(b.total_payout_vnd or 0) }}</td></tr>
  <tr><th>KÃªnh</th><td>{{ b.channel_name }}</td></tr>
</table>

<!-- Room Assignment Section -->
<h2 style="margin-top: 32px;">ğŸ  PhÃ¢n bá»• phÃ²ng</h2>
{% if room_assignment %}
  <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <table style="margin: 0;">
      <tr><th>PhÃ²ng Ä‘Ã£ Ä‘áº·t</th><td><strong>{{ room_assignment.booked_room or 'â€”' }}</strong></td></tr>
      <tr><th>PhÃ²ng thá»±c táº¿</th><td><strong>{{ room_assignment.actual_room or 'â€”' }}</strong></td></tr>
      {% if room_assignment.booked_room and room_assignment.actual_room and room_assignment.booked_room != room_assignment.actual_room %}
        <tr style="background: #fff3cd;">
          <th>âš ï¸ Äá»•i phÃ²ng</th>
          <td><strong>{{ room_assignment.booked_room }} â†’ {{ room_assignment.actual_room }}</strong></td>
        </tr>
        <tr><th>PhÃ¢n bá»• doanh thu</th><td>
          {% if room_assignment.revenue_attribution == "booked_room" %}
            ğŸ“ PhÃ²ng Ä‘Ã£ Ä‘áº·t ({{ room_assignment.booked_room }})
          {% elif room_assignment.revenue_attribution == "actual_room" %}
            ğŸ  PhÃ²ng thá»±c táº¿ ({{ room_assignment.actual_room }})
          {% elif room_assignment.revenue_attribution == "split" %}
            âš–ï¸ Chia Ä‘Ã´i
          {% else %}
            ğŸ  PhÃ²ng thá»±c táº¿ (máº·c Ä‘á»‹nh)
          {% endif %}
        </td></tr>
        <tr><th>LÃ½ do Ä‘á»•i</th><td>{{ room_assignment.change_reason or 'â€”' }}</td></tr>
        <tr><th>NgÃ y Ä‘á»•i</th><td>{{ room_assignment.changed_date or 'â€”' }}</td></tr>
        <tr><th>NgÆ°á»i Ä‘á»•i</th><td>{{ room_assignment.changed_by or 'â€”' }}</td></tr>
      {% endif %}
      {% if room_assignment.notes %}
        <tr><th>Ghi chÃº</th><td>{{ room_assignment.notes }}</td></tr>
      {% endif %}
    </table>
  </div>
{% else %}
  <div style="background: #e9ecef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <p style="margin: 0; color: #6c757d;">
      ğŸ“ ChÆ°a cÃ³ thÃ´ng tin phÃ¢n bá»• phÃ²ng. 
      <a href="/bookings/{{ b.id }}/room-assignment" style="color: #007bff;">ThÃªm phÃ¢n bá»• phÃ²ng</a>
    </p>
  </div>
{% endif %}

<!-- Revenue Attribution -->
{% if revenue_attribution %}
  <h3>ğŸ’° PhÃ¢n bá»• doanh thu</h3>
  <div style="background: #d4edda; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <table style="margin: 0;">
      <tr><th>Tá»•ng doanh thu</th><td><strong>{{ "{:,}".format(revenue_attribution.total_revenue) }} VND</strong></td></tr>
      {% if revenue_attribution.room_change %}
        <tr><th>PhÃ²ng {{ revenue_attribution.booked_room }}</th><td>{{ "{:,}".format(revenue_attribution.booked_room_revenue) }} VND</td></tr>
        <tr><th>PhÃ²ng {{ revenue_attribution.actual_room }}</th><td>{{ "{:,}".format(revenue_attribution.actual_room_revenue) }} VND</td></tr>
        <tr><th>PhÆ°Æ¡ng phÃ¡p</th><td>{{ revenue_attribution.attribution_method }}</td></tr>
      {% else %}
        <tr><th>PhÃ¢n bá»•</th><td>ToÃ n bá»™ cho phÃ²ng Ä‘Ã£ Ä‘áº·t (khÃ´ng cÃ³ Ä‘á»•i phÃ²ng)</td></tr>
      {% endif %}
    </table>
  </div>
{% endif %}

<!-- Action Buttons -->
<div style="margin-top: 24px;">
  <a href="/bookings/{{ b.id }}/edit" class="btn">âœï¸ Chá»‰nh sá»­a booking</a>
  <a href="/bookings/{{ b.id }}/room-assignment" class="btn" style="margin-left: 8px;">ğŸ  Quáº£n lÃ½ phÃ²ng</a>
</div>

{% endblock %}
