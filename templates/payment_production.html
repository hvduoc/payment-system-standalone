<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Thu Chi Airbnb - Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .receipt-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        .handover-card {
            border-left: 4px solid #10b981;
        }
        .role-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .role-assistant { background-color: #dbeafe; color: #1e40af; }
        .role-manager { background-color: #fef3c7; color: #d97706; }
        .role-owner { background-color: #ecfdf5; color: #059669; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>
                    Hệ thống Thu Chi Airbnb
                    <span class="text-sm text-green-600 font-normal ml-2">v2.0 Production</span>
                </h1>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="currentTime"></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-700" id="currentUser"></span>
                        <span id="userRole" class="role-badge"></span>
                    </div>
                    <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800">
                        <i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Navigation Tabs -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8">
                <button onclick="showTab('dashboard')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm" data-tab="dashboard">
                    <i class="fas fa-chart-line mr-2"></i>Tổng quan
                </button>
                <button onclick="showTab('add-payment')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm" data-tab="add-payment">
                    <i class="fas fa-plus-circle mr-2"></i>Ghi nhận thu
                </button>
                <button onclick="showTab('handover')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm" data-tab="handover">
                    <i class="fas fa-handshake mr-2"></i>Bàn giao
                </button>
                <button onclick="showTab('payments-list')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm" data-tab="payments-list">
                    <i class="fas fa-list mr-2"></i>Lịch sử thu
                </button>
                <button onclick="showTab('handover-list')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm" data-tab="handover-list">
                    <i class="fas fa-history mr-2"></i>Lịch sử bàn giao
                </button>
                <button onclick="showTab('team')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm" data-tab="team" id="teamTab">
                    <i class="fas fa-users mr-2"></i>Đội ngũ
                </button>
            </nav>
        </div>

        <!-- Tab Tổng quan -->
        <div id="dashboard-tab" class="tab-content">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-lg">
                            <i class="fas fa-money-bill text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Tổng thu</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalCollected">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i class="fas fa-percentage text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Tỷ lệ thu</p>
                            <p class="text-2xl font-semibold text-gray-900" id="collectionRate">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-lg">
                            <i class="fas fa-wallet text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Tiền mặt cần bàn giao</p>
                            <p class="text-2xl font-semibold text-gray-900" id="cashPending">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-purple-100 rounded-lg">
                            <i class="fas fa-handshake text-purple-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Số lần bàn giao</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalHandovers">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thông báo hệ thống -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-8">
                <div class="flex items-center">
                    <i class="fas fa-database text-green-600 mr-3"></i>
                    <div>
                        <h3 class="text-sm font-medium text-green-800">Production Version 2.0</h3>
                        <p class="text-sm text-green-700">Hệ thống sử dụng SQLite database bền vững. Dữ liệu được lưu trữ an toàn và không bị mất khi restart.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Ghi nhận thu -->
        <div id="add-payment-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-6">Ghi nhận khoản thu mới</h2>
                <form id="paymentForm" class="space-y-6" enctype="multipart/form-data">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Mã booking <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="bookingId" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tên khách <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="guestName" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Số tiền phải thu (VNĐ) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="amountDue" required min="0"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Số tiền đã thu (VNĐ) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="amountCollected" required min="0"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Phương thức thanh toán <span class="text-red-500">*</span>
                            </label>
                            <select id="paymentMethod" required
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Chọn phương thức</option>
                                <option value="cash">Tiền mặt</option>
                                <option value="bank_transfer">Chuyển khoản ngân hàng</option>
                                <option value="airbnb_payout">Thanh toán Airbnb</option>
                                <option value="momo">Ví MoMo</option>
                                <option value="zalopay">Ví ZaloPay</option>
                                <option value="vnpay">Ví VNPay</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Người thu <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="collectedBy" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Hình ảnh biên lai/chứng từ
                            </label>
                            <input type="file" id="receiptImage" accept="image/*"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">Chọn hình ảnh biên lai, chuyển khoản hoặc chứng từ thu (JPG, PNG)</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ghi chú
                            </label>
                            <textarea id="notes" rows="3"
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                      placeholder="Thêm ghi chú về khoản thu này..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="resetPaymentForm()"
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Xóa form
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-save mr-2"></i>Lưu khoản thu
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab Bàn giao -->
        <div id="handover-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-6">Bàn giao tiền mặt</h2>
                <form id="handoverForm" class="space-y-6" enctype="multipart/form-data">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Người nhận <span class="text-red-500">*</span>
                            </label>
                            <select id="recipientId" required
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Chọn người nhận</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Số tiền bàn giao (VNĐ) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="handoverAmount" required min="0"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Hình ảnh bàn giao
                            </label>
                            <input type="file" id="handoverImage" accept="image/*"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">Chụp ảnh quá trình bàn giao, chữ ký xác nhận (JPG, PNG)</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ghi chú bàn giao
                            </label>
                            <textarea id="handoverNotes" rows="3"
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                      placeholder="Ghi chú về việc bàn giao..."></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                            <div>
                                <h3 class="text-sm font-medium text-yellow-800">Lưu ý quan trọng</h3>
                                <p class="text-sm text-yellow-700">Vui lòng kiểm tra kỹ số tiền và chụp ảnh xác nhận trước khi hoàn tất bàn giao.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="resetHandoverForm()"
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Xóa form
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-handshake mr-2"></i>Xác nhận bàn giao
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab Lịch sử thu -->
        <div id="payments-list-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold">Lịch sử khoản thu</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thời gian</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã booking</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khách</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phải thu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Đã thu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phương thức</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Người thu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hình ảnh</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu sẽ được load ở đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Lịch sử bàn giao -->
        <div id="handover-list-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold">Lịch sử bàn giao</h2>
                </div>
                
                <div id="handoverListContainer" class="p-6">
                    <!-- Danh sách bàn giao sẽ được load ở đây -->
                </div>
            </div>
        </div>

        <!-- Tab Đội ngũ -->
        <div id="team-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold">Danh sách đội ngũ</h2>
                </div>
                
                <div id="teamListContainer" class="p-6">
                    <!-- Danh sách team sẽ được load ở đây -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Thông báo -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i id="toastIcon" class="text-xl"></i>
                </div>
                <div class="ml-3">
                    <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xem hình ảnh -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl max-h-screen p-4">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-2xl z-10">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Hình ảnh" class="max-w-full max-h-full object-contain">
        </div>
    </div>

    <script>
        let currentUser = null;
        let recipients = [];
        let teamMembers = [];

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentUser();
            showTab('dashboard');
            updateClock();
            setInterval(updateClock, 1000);
        });

        async function loadCurrentUser() {
            try {
                // Giả lập load user từ token hoặc session
                // Trong thực tế, sẽ verify JWT token
                await loadDashboard();
                await loadRecipients();
                await loadTeamMembers();
            } catch (error) {
                // Redirect đến login nếu không authenticate được
                window.location.href = '/login';
            }
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleString('vi-VN');
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // Phần còn lại của script giống như phiên bản trước...
        // [Script đầy đủ sẽ được thêm vào]
    </script>

    <script src="/static/payment_production.js"></script>
</body>
</html>