{% extends "payment_layout.html" %}

{% block title %}Bàn giao tiền - Hệ thống Thu Chi Airbnb{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* Custom modal styles */
    .modal-overlay {
        z-index: 9999 !important;
        backdrop-filter: blur(2px);
    }
    .modal-content {
        max-height: 85vh;
        overflow-y: auto;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
    /* Ensure body doesn't scroll when modal is open */
    body.modal-open {
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
    
    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Bàn giao tiền mặt</h2>
                <p class="text-gray-600">Quản lý việc bàn giao tiền mặt giữa các thành viên</p>
            </div>
            <button onclick="openCreateHandoverModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-handshake mr-2"></i>Tạo bàn giao
            </button>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Tiền mặt chờ bàn giao</p>
                        <p id="cashPending" class="text-2xl font-bold text-gray-900">0 đ</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-handshake text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Đã bàn giao</p>
                        <p id="totalHandovers" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Tổng bàn giao</p>
                        <p id="totalAmount" class="text-2xl font-bold text-gray-900">0 đ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Handovers List -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <div id="loading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                    <p class="text-gray-500 mt-2">Đang tải danh sách bàn giao...</p>
                </div>
                
                <div id="handoversList" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Thời gian</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Người bàn giao</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Người nhận</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Số tiền</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Trạng thái</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="handoversTableBody" class="divide-y divide-gray-200">
                                <!-- Handovers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Handover Modal -->
    <div id="handoverModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Tạo bàn giao tiền mặt</h3>
                <button onclick="closeHandoverModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="handoverForm" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tòa nhà</label>
                    <select id="buildingId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Chọn tòa nhà</option>
                        <!-- Buildings will be loaded dynamically -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Người nhận</label>
                    <input type="text" id="toPerson" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập tên người nhận" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Số tiền bàn giao</label>
                    <input type="number" id="handoverAmount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                    <textarea id="handoverNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hình ảnh bàn giao</label>
                    <input type="file" id="handoverImage" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-handshake mr-2"></i>Tạo bàn giao
                    </button>
                    <button type="button" onclick="closeHandoverModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">
                        Hủy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let handovers = [];
        let buildings = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadBuildings();
            loadHandovers();
            loadDashboard();
            
            // Close modal when clicking outside
            document.getElementById('handoverModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeHandoverModal();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !document.getElementById('handoverModal').classList.contains('hidden')) {
                    closeHandoverModal();
                }
            });
        });

        async function loadBuildings() {
            try {
                const response = await axios.get('/api/buildings');
                buildings = response.data.buildings;
                
                const select = document.getElementById('buildingId');
                select.innerHTML = '<option value="">Chọn tòa nhà</option>';
                
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.id;
                    option.textContent = `${building.name} - ${building.address || ''}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading buildings:', error);
            }
        }

        async function loadHandovers() {
            try {
                const response = await axios.get('/api/handovers');
                handovers = response.data.handovers;
                renderHandovers();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('handoversList').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading handovers:', error);
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                    <p class="text-red-500 mt-2">Lỗi khi tải danh sách bàn giao</p>
                `;
            }
        }

        async function loadDashboard() {
            try {
                const response = await axios.get('/api/dashboard');
                const data = response.data;
                
                document.getElementById('cashPending').textContent = 
                    `${data.cash_pending_handover.toLocaleString()} đ`;
                document.getElementById('totalHandovers').textContent = data.total_handovers;
                document.getElementById('totalAmount').textContent = 
                    `${(data.cash_balance || 0).toLocaleString()} đ`;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function renderHandovers() {
            const tbody = document.getElementById('handoversTableBody');
            tbody.innerHTML = '';

            handovers.forEach(handover => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColors = {
                    'completed': 'bg-green-100 text-green-800',
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'cancelled': 'bg-red-100 text-red-800'
                };

                // Format date
                const createdDate = new Date(handover.created_at).toLocaleString('vi-VN');

                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${createdDate}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${handover.handover_by}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="text-gray-900">${handover.to_person}</div>
                        <div class="text-gray-500 text-xs">${handover.building_name || ''}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${handover.amount.toLocaleString()} đ</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[handover.status] || 'bg-gray-100 text-gray-800'}">
                            ${handover.status}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            ${handover.image_path ? 
                                `<button onclick="viewHandoverImage('${handover.image_path}')" class="text-blue-600 hover:text-blue-800" title="Xem hình ảnh">
                                    <i class="fas fa-image"></i>
                                </button>` : 
                                ''
                            }
                            <button onclick="viewHandoverDetails(${handover.id})" class="text-green-600 hover:text-green-800" title="Chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editHandover(${handover.id})" class="text-yellow-600 hover:text-yellow-800" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteHandover(${handover.id})" class="text-red-600 hover:text-red-800" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openCreateHandoverModal() {
            document.getElementById('handoverForm').reset();
            
            // Reset modal for create mode
            document.querySelector('#handoverModal h3').textContent = 'Tạo bàn giao tiền mặt';
            document.querySelector('#handoverForm button[type="submit"]').textContent = 'Tạo bàn giao';
            document.getElementById('handoverForm').dataset.mode = 'create';
            
            // Remove edit ID if exists
            const existingIdInput = document.getElementById('editHandoverId');
            if (existingIdInput) {
                existingIdInput.remove();
            }
            
            // Show modal and prevent body scroll
            document.getElementById('handoverModal').classList.remove('hidden');
            document.body.classList.add('modal-open');
        }

        function closeHandoverModal() {
            document.getElementById('handoverModal').classList.add('hidden');
            document.body.classList.remove('modal-open');
            
            // Reset form
            document.getElementById('handoverForm').reset();
            document.querySelector('#handoverModal h3').textContent = 'Tạo bàn giao tiền mặt';
            document.querySelector('#handoverForm button[type="submit"]').textContent = 'Tạo bàn giao';
            document.getElementById('handoverForm').dataset.mode = 'create';
            
            // Remove edit ID if exists
            const existingIdInput = document.getElementById('editHandoverId');
            if (existingIdInput) {
                existingIdInput.remove();
            }
        }

        document.getElementById('handoverForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('building_id', document.getElementById('buildingId').value);
            formData.append('to_person', document.getElementById('toPerson').value);
            formData.append('amount', document.getElementById('handoverAmount').value);
            formData.append('notes', document.getElementById('handoverNotes').value);
            
            const handoverImage = document.getElementById('handoverImage').files[0];
            if (handoverImage) {
                formData.append('handover_image', handoverImage);
            }

            const mode = this.dataset.mode || 'create';
            const editId = document.getElementById('editHandoverId')?.value;

            try {
                let response;
                
                if (mode === 'edit' && editId) {
                    // Update existing handover
                    response = await axios.put(`/api/handovers/${editId}`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    });
                } else {
                    // Create new handover
                    response = await axios.post('/api/handovers', formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    });
                }

                if (response.data.success) {
                    closeHandoverModal();
                    loadHandovers();
                    loadDashboard();
                    alert(mode === 'edit' ? 'Cập nhật bàn giao thành công!' : 'Tạo bàn giao thành công!');
                } else {
                    alert('Lỗi: ' + (response.data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Full error:', error);
                alert('Lỗi: ' + (error.response?.data?.detail || error.message));
            }
        });

        function viewHandoverImage(imagePath) {
            window.open(imagePath, '_blank');
        }

        function viewHandoverDetails(handoverId) {
            const handover = handovers.find(h => h.id === handoverId);
            if (handover) {
                alert(`Chi tiết bàn giao:\n\nNgười bàn giao: ${handover.handover_by}\nNgười nhận: ${handover.to_person}\nSố tiền: ${handover.amount.toLocaleString()} đ\nTrạng thái: ${handover.status}\nGhi chú: ${handover.notes || 'Không có'}`);
            }
        }

        // Edit handover function
        async function editHandover(handoverId) {
            try {
                const response = await axios.get(`/api/handovers/${handoverId}`);
                const handover = response.data;
                
                // Populate form with existing data
                document.getElementById('buildingId').value = handover.building_id || '';
                document.getElementById('toPerson').value = handover.to_person || '';
                document.getElementById('handoverAmount').value = handover.amount || '';
                document.getElementById('handoverNotes').value = handover.notes || '';
                
                // Change modal title and form action
                document.querySelector('#handoverModal h3').textContent = 'Chỉnh sửa bàn giao';
                
                // Add hidden input for handover ID
                const existingIdInput = document.getElementById('editHandoverId');
                if (existingIdInput) {
                    existingIdInput.remove();
                }
                
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.id = 'editHandoverId';
                idInput.value = handoverId;
                document.getElementById('handoverForm').appendChild(idInput);
                
                // Change submit button text
                const submitBtn = document.querySelector('#handoverForm button[type="submit"]');
                submitBtn.textContent = 'Cập nhật bàn giao';
                
                // Mark form as edit mode
                document.getElementById('handoverForm').dataset.mode = 'edit';
                
                // Show modal
                document.getElementById('handoverModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
                
            } catch (error) {
                console.error('Error loading handover for edit:', error);
                alert('Lỗi khi tải thông tin bàn giao: ' + (error.response?.data?.detail || error.message));
            }
        }

        // Delete handover function
        async function deleteHandover(handoverId) {
            const handover = handovers.find(h => h.id === handoverId);
            if (!handover) return;
            
            const confirmDelete = confirm(`Bạn có chắc chắn muốn xóa bàn giao này?\n\nNgười nhận: ${handover.to_person}\nSố tiền: ${handover.amount.toLocaleString()} đ\n\nThao tác này không thể hoàn tác!`);
            
            if (confirmDelete) {
                try {
                    const response = await axios.delete(`/api/handovers/${handoverId}`);
                    
                    if (response.data.success) {
                        alert('Xóa bàn giao thành công!');
                        loadHandovers();
                        loadDashboard();
                    } else {
                        alert('Lỗi: ' + (response.data.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting handover:', error);
                    alert('Lỗi khi xóa bàn giao: ' + (error.response?.data?.detail || error.message));
                }
            }
        }
    </script>
{% endblock %}