{% extends "layout.html" %}
{% block content %}
<style>
/* ===== Header ===== */
.page-header{
  display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:12px;
}
.page-header h1{margin:0}

/* ===== Filter Card ===== */
.filter-card{
  background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 4px 12px rgba(15,23,42,.04);
  padding:16px 16px 12px;margin-bottom:20px;
}
.fgrid{
  display:grid;gap:12px 16px;align-items:end;
  grid-template-columns: repeat(12,minmax(0,1fr));
}

/* h√†ng 1: range + status + channel */
.fg-range{grid-column: span 6}
.fg-status{grid-column: span 3}
.fg-channel{grid-column: span 3}

/* h√†ng 2: building + property + buttons + tools */
.fg-building{grid-column: span 3}
.fg-property{grid-column: span 3}
.fg-actions{grid-column: span 3; display:flex; gap:8px; align-items:center}
.fg-tools{grid-column: span 3; display:flex; gap:12px; justify-content:flex-end; align-items:center}

/* date-range field */
.range{
  display:flex;gap:8px;align-items:center;
}
.range .dash{color:var(--muted)}

/* column dropdown */
.column-toggle{position:relative}
.column-toggle-btn{
  background:#fff;border:1px solid var(--line);padding:8px 10px;border-radius:8px;cursor:pointer;
}
.column-dropdown{
  position:absolute;right:0;top:calc(100% + 6px);display:none;width:220px;background:#fff;border:1px solid var(--line);
  border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:8px;z-index:10;
}
.column-dropdown.show{display:block}
.column-dropdown label{display:flex;gap:8px;align-items:center;padding:8px;border-radius:6px;font-size:14px}
.column-dropdown label:hover{background:#f5f7fb}

/* ===== Table ===== */
.table-container{border:1px solid var(--line);border-radius:12px;overflow-x:auto}
.booking-table{width:100%;border-collapse:collapse}
.booking-table th{background:#f9fafb;position:relative}
.resizer{position:absolute;top:0;right:-2px;width:5px;height:100%;cursor:col-resize}
.resizer:hover,.resizing{background:#3b82f6}

.subtext{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}

/* ===== Mobile ===== */
@media (max-width: 900px){
  .fg-range{grid-column:1 / -1}
  .fg-status,.fg-channel,.fg-building,.fg-property{grid-column: span 6}
  .fg-actions{grid-column: span 6}
  .fg-tools{grid-column: span 6;justify-content:flex-start}

  .booking-table thead{display:none}
  .booking-table tr{display:block;margin:10px 8px;border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
  .booking-table td{display:grid;grid-template-columns:120px 1fr;gap:10px;padding:8px 0;border-bottom:1px dashed #eee;text-align:right}
  .booking-table td:last-child{border-bottom:none}
  .booking-table td::before{content:attr(data-label);text-align:left;color:var(--muted);font-weight:500}
  .subtext{max-width:100%;white-space:normal}
}

/* ===== Pager ===== */
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:12px;flex-wrap:wrap}
.pager .info{margin-right:auto;color:var(--muted)}
.pager .btn{padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:8px;color:var(--fg);text-decoration:none}
.pager .btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none}
.pager .btn.active{background:#0b57d0;color:#fff;border-color:#0b57d0}
</style>

<div class="page-header">
  <h1>Danh s√°ch ƒë·∫∑t ph√≤ng</h1>
  <div class="header-actions">
    <a href="/bookings/new" class="btn btn-green">‚ûï Th√™m Offline</a>
  </div>
</div>

<div class="filter-card">
  <form method="get" action="/bookings" class="fgrid">
    <!-- H√†ng 1 -->
    <div class="fg-range">
      <label>Kho·∫£ng ng√†y</label>
      <div class="range">
        <input type="date" name="start" value="{{ start.strftime('%Y-%m-%d') if start else '' }}">
        <span class="dash">‚Äî</span>
        <input type="date" name="end" value="{{ end.strftime('%Y-%m-%d') if end else '' }}">
      </div>
    </div>

    <div class="fg-status">
      <label>Tr·∫°ng th√°i</label>
      <select name="status">
        <option value="">T·∫•t c·∫£</option>
        <option value="x√°c nh·∫≠n" {{ 'selected' if status == 'x√°c nh·∫≠n' else '' }}>ƒê√£ x√°c nh·∫≠n</option>
        <option value="h·ªßy" {{ 'selected' if status == 'h·ªßy' else '' }}>Kh√°ch ƒë√£ h·ªßy</option>
      </select>
    </div>

    <div class="fg-channel">
      <label>K√™nh</label>
      <input type="text" name="channel" value="{{ channel or '' }}" placeholder="Airbnb / Offline ‚Ä¶">
    </div>

    <!-- H√†ng 2 -->
    <div class="fg-building">
      <label>T√≤a nh√†</label>
      <select name="building">
        <option value="">T·∫•t c·∫£ t√≤a nh√†</option>
        {% for bld in all_buildings %}
          <option value="{{ bld }}" {{ 'selected' if building == bld else '' }}>{{ bld }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="fg-property">
      <label>CƒÉn h·ªô</label>
      <input type="text" name="property" value="{{ property or '' }}" placeholder="AVA-403 ‚Ä¶">
    </div>

    <div class="fg-actions">
      <button class="btn btn-blue" type="submit">üîç L·ªçc</button>
      <a class="btn btn-gray" href="/bookings">X√≥a l·ªçc</a>
    </div>

    <div class="fg-tools">
      <label style="display:flex;align-items:center;gap:8px">
        <span style="color:var(--muted)">H√†ng/trang</span>
        <select name="page_size" onchange="this.form.submit()">
          {% set _psize = (pagination.page_size if pagination else 50) %}
          {% for n in [20,50,100,150,200] %}
            <option value="{{n}}" {{ 'selected' if _psize==n else '' }}>{{n}}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="p" value="1">
      </label>

      <div class="column-toggle">
        <button type="button" class="column-toggle-btn" onclick="toggleColumnDropdown()">‚öôÔ∏è T√πy ch·ªânh c·ªôt</button>
        <div id="columnDropdown" class="column-dropdown"></div>
      </div>
    </div>
  </form>
</div>

<div class="table-container">
  <table class="booking-table" id="bookingTable">
    <thead>
      <tr>
        <th data-col-name="M√£">M√£<div class="resizer"></div></th>
        <th data-col-name="Listing">Listing<div class="resizer"></div></th>
        <th data-col-name="Bƒê">Bƒê<div class="resizer"></div></th>
        <th data-col-name="KT">KT<div class="resizer"></div></th>
        <th data-col-name="ƒê√™m" class="num">ƒê√™m<div class="resizer"></div></th>
        <th data-col-name="Tr·∫°ng th√°i">Tr·∫°ng th√°i<div class="resizer"></div></th>
        <th data-col-name="Thu nh·∫≠p" class="num">Thu nh·∫≠p<div class="resizer"></div></th>
        <th data-col-name="K√™nh">K√™nh<div class="resizer"></div></th>
        <th data-col-name="Kh√°ch">Kh√°ch<div class="resizer"></div></th>
        <th data-col-name="Li√™n h·ªá">Li√™n h·ªá<div class="resizer"></div></th>
        <th data-col-name="SL Kh√°ch">SL Kh√°ch<div class="resizer"></div></th>
        <th data-col-name="Ng√†y ƒë·∫∑t">Ng√†y ƒë·∫∑t<div class="resizer"></div></th>
        <th data-col-name="Thao t√°c">Thao t√°c</th>
      </tr>
    </thead>
    <tbody>
      {% for b in bookings %}
        {% set st = b.status|default('')|lower %}
        {% if 'h·ªßy' in st or 't·ª´ ch·ªëi' in st or 'h·∫øt h·∫°n' in st %}{% set dot_class = 'cancel' %}
        {% elif 'x√°c nh·∫≠n' in st or 'ƒëang ƒë√≥n ti·∫øp' in st or 'ƒë√°nh gi√°' in st or 'kh√°ch tr∆∞·ªõc ƒë√¢y' in st or 's·∫Øp t·ªõi' in st %}{% set dot_class = 'ok' %}
        {% else %}{% set dot_class = 'warn' %}{% endif %}

        <tr>
          <td data-label="M√£">{{ b.confirmation_code }}</td>
          <td data-label="Listing" title="{{ b.listing_raw }}">
            <div style="font-weight:600">{{ b.property_short or '‚Äî' }}</div>
            {% if b.listing_raw and b.listing_raw != b.property_short %}
              <div class="subtext">{{ b.listing_raw }}</div>
            {% endif %}
          </td>

          <td data-label="Bƒê">{{ b.start_date }}</td>
          <td data-label="KT">{{ b.end_date }}</td>
          <td data-label="ƒê√™m" class="num">{{ b.num_nights }}</td>
          <td data-label="Tr·∫°ng th√°i" title="{{ b.status }}"><span class="dot {{ dot_class }}"></span></td>
          <td data-label="Thu nh·∫≠p" class="num">{{ "{:,}".format(b.total_payout_vnd or 0) }}</td>
          <td data-label="K√™nh">{{ b.channel_name }}</td>
          <td data-label="Kh√°ch">{{ b.guest_name }}</td>
          <td data-label="Li√™n h·ªá">{{ b.guest_contact }}</td>
          <td data-label="SL Kh√°ch">{{ b.num_adults or 0 }}/{{ b.num_children or 0 }}/{{ b.num_infants or 0 }}</td>
          <td data-label="Ng√†y ƒë·∫∑t">{{ b.booking_date }}</td>
          <td data-label="Thao t√°c" class="actions">
            <div style="display:flex;gap:8px;align-items:center">
              <a href="/bookings/{{ b.id }}" title="Chi ti·∫øt">üëÅÔ∏è</a>
              <a href="/bookings/{{ b.id }}/edit" title="S·ª≠a">‚úèÔ∏è</a>
              <form method="post" action="/bookings/{{ b.id }}/delete" class="inline-form"
                    onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?');">
                <button type="submit" title="X√≥a" class="danger">üóëÔ∏è</button>
              </form>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if pagination %}
    {% set base = '/bookings?'
      ~ ('start=' ~ (start.strftime('%Y-%m-%d') if start else '') )
      ~ ('&end=' ~ (end.strftime('%Y-%m-%d') if end else '') )
      ~ ('&status=' ~ (status|urlencode if status else '') )
      ~ ('&channel=' ~ (channel|urlencode if channel else '') )
      ~ ('&building=' ~ (building|urlencode if building else '') )
      ~ ('&property=' ~ (property|urlencode if property else '') )
      ~ ('&page_size=' ~ pagination.page_size) %}
    <div class="pager">
      <div class="info">K·∫øt qu·∫£: {{ pagination.start }}‚Äì{{ pagination.end }} / {{ pagination.total }}</div>
      <a class="btn" href="{{ base ~ '&p=1' }}" {{ 'disabled' if pagination.page==1 else '' }}>¬´ ƒê·∫ßu</a>
      <a class="btn" href="{{ base ~ '&p=' ~ (pagination.page-1) }}" {{ 'disabled' if pagination.page==1 else '' }}>‚Äπ Tr∆∞·ªõc</a>
      {% set from = [1, pagination.page-2]|max %}
      {% set to = [pagination.pages, pagination.page+2]|min %}
      {% for i in range(from, to+1) %}
        <a class="btn {{ 'active' if i==pagination.page else '' }}" href="{{ base ~ '&p=' ~ i }}">{{ i }}</a>
      {% endfor %}
      <a class="btn" href="{{ base ~ '&p=' ~ (pagination.page+1) }}" {{ 'disabled' if pagination.page==pagination.pages else '' }}>Sau ‚Ä∫</a>
      <a class="btn" href="{{ base ~ '&p=' ~ pagination.pages }}" {{ 'disabled' if pagination.page==pagination.pages else '' }}>Cu·ªëi ¬ª</a>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const table = document.getElementById('bookingTable');
  const headers = Array.from(table.querySelectorAll('thead th'));
  const columnDropdown = document.getElementById('columnDropdown');

  // 1) T·∫°o checkbox cho dropdown "T√πy ch·ªânh c·ªôt"
  headers.forEach((header, index) => {
    const name = header.getAttribute('data-col-name');
    const colIdx = index + 1;
    const defaultOn = !['Li√™n h·ªá','SL Kh√°ch','Ng√†y ƒë·∫∑t'].includes(name); // ·∫©n b·ªõt c·ªôt √≠t quan tr·ªçng

    const wrap = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = defaultOn;
    cb.addEventListener('change', () => toggleColumn(colIdx, cb.checked));

    wrap.appendChild(cb);
    wrap.appendChild(document.createTextNode(' ' + name));
    columnDropdown.appendChild(wrap);
  });

  // 2) Ph·ª•c h·ªìi tr·∫°ng th√°i t·ª´ localStorage
  const cbs = columnDropdown.querySelectorAll('input[type="checkbox"]');
  cbs.forEach((cb, idx) => {
    const k = 'col_visibility_' + idx;
    const v = localStorage.getItem(k);
    if (v !== null) cb.checked = (v === 'true');
    toggleColumn(idx + 1, cb.checked);
  });

  // 3) K√©o co gi√£n c·ªôt
  headers.forEach((header) => {
    const resizer = header.querySelector('.resizer');
    if (!resizer) return;
    resizer.addEventListener('mousedown', function (e) {
      e.preventDefault();
      const startX = e.pageX;
      const startW = header.offsetWidth;
      const move = (ev) => {
        const w = startW + (ev.pageX - startX);
        if (w > 60) header.style.width = w + 'px';
      };
      const up = () => {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);
      };
      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', up);
    });
  });
});

// Toggle dropdown
function toggleColumnDropdown(){
  document.getElementById('columnDropdown').classList.toggle('show');
}
// Hide dropdown when clicking outside
window.addEventListener('click', function(e){
  const dd = document.getElementById('columnDropdown');
  const btn = document.querySelector('.column-toggle-btn');
  if (!dd.contains(e.target) && !btn.contains(e.target)) dd.classList.remove('show');
});

// Show/Hide column
function toggleColumn(idx, visible){
  const t = document.getElementById('bookingTable');
  const cells = t.querySelectorAll(`tr > *:nth-child(${idx})`);
  cells.forEach(c => c.style.display = visible ? '' : 'none');
  localStorage.setItem('col_visibility_' + (idx - 1), visible);
}
</script>
{% endblock %}
