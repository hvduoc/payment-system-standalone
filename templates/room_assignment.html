{% extends "layout.html" %}
{% block content %}
<h1>ğŸ  Quáº£n lÃ½ phÃ¢n bá»• phÃ²ng</h1>
<p class="muted">
  <a href="/bookings/{{ booking.id }}">â† Quay láº¡i booking {{ booking.confirmation_code }}</a>
</p>

<!-- Booking Context -->
<div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
  <h3 style="margin: 0 0 8px 0;">ğŸ“‹ Booking Context</h3>
  <p style="margin: 0;"><strong>{{ booking.guest_name }}</strong> â€¢ {{ booking.start_date }} - {{ booking.end_date }} â€¢ {{ "{:,}".format(booking.total_payout_vnd or 0) }} VND</p>
  <p style="margin: 4px 0 0 0; color: #6c757d;">{{ booking.listing_raw or booking.property_short }}</p>
</div>

<!-- Room Assignment Form -->
<form method="post" action="/bookings/{{ booking.id }}/room-assignment" style="max-width: 600px;">
  
  <h2>ğŸ  ThÃ´ng tin phÃ²ng</h2>
  
  <label>PhÃ²ng Ä‘Ã£ Ä‘áº·t (tá»« booking)
    <select name="booked_room" required>
      <option value="">-- Chá»n phÃ²ng Ä‘Ã£ Ä‘áº·t --</option>
      {% for prop in properties %}
        <option value="{{ prop.property_short or prop.property_name }}" 
                {{ 'selected' if room_assignment and room_assignment.booked_room == (prop.property_short or prop.property_name) else '' }}>
          {{ prop.property_short or prop.property_name }} 
          {% if prop.airbnb_name and prop.airbnb_name != (prop.property_short or prop.property_name) %}
            - {{ prop.airbnb_name }}
          {% endif %}
        </option>
      {% endfor %}
    </select>
    <small>PhÃ²ng Ä‘Æ°á»£c khÃ¡ch book ban Ä‘áº§u trong reservation</small>
  </label>
  
  <label>PhÃ²ng thá»±c táº¿ (khÃ¡ch á»Ÿ tháº­t)
    <select name="actual_room" required>
      <option value="">-- Chá»n phÃ²ng thá»±c táº¿ --</option>
      {% for prop in properties %}
        <option value="{{ prop.property_short or prop.property_name }}" 
                {{ 'selected' if room_assignment and room_assignment.actual_room == (prop.property_short or prop.property_name) else '' }}>
          {{ prop.property_short or prop.property_name }}
          {% if prop.airbnb_name and prop.airbnb_name != (prop.property_short or prop.property_name) %}
            - {{ prop.airbnb_name }}
          {% endif %}
        </option>
      {% endfor %}
    </select>
    <small>PhÃ²ng thá»±c táº¿ khÃ¡ch check-in vÃ  á»Ÿ</small>
  </label>
  
  <!-- Revenue Attribution -->
  <h2 style="margin-top: 32px;">ğŸ’° PhÃ¢n bá»• doanh thu</h2>
  
  <label>Doanh thu tÃ­nh cho phÃ²ng nÃ o?
    <select name="revenue_attribution" required>
      <option value="actual_room" {{ 'selected' if (room_assignment and room_assignment.revenue_attribution == 'actual_room') or not room_assignment else '' }}>
        ğŸ  PhÃ²ng thá»±c táº¿ (khuyáº¿n nghá»‹)
      </option>
      <option value="booked_room" {{ 'selected' if room_assignment and room_assignment.revenue_attribution == 'booked_room' else '' }}>
        ğŸ“ PhÃ²ng Ä‘Ã£ Ä‘áº·t
      </option>
      <option value="split" {{ 'selected' if room_assignment and room_assignment.revenue_attribution == 'split' else '' }}>
        âš–ï¸ Chia Ä‘Ã´i
      </option>
    </select>
    <small>Quy táº¯c phÃ¢n bá»• {{ "{:,}".format(booking.total_payout_vnd or 0) }} VND</small>
  </label>
  
  <!-- Change Details -->
  <h2 style="margin-top: 32px;">ğŸ“ Chi tiáº¿t thay Ä‘á»•i</h2>
  
  <label>LÃ½ do Ä‘á»•i phÃ²ng
    <select name="change_reason" required>
      <option value="" {{ 'selected' if not room_assignment or not room_assignment.change_reason else '' }}>-- Chá»n lÃ½ do --</option>
      <option value="maintenance" {{ 'selected' if room_assignment and room_assignment.change_reason == 'maintenance' else '' }}>
        ğŸ”§ Báº£o trÃ¬ phÃ²ng Ä‘Ã£ Ä‘áº·t
      </option>
      <option value="guest_request" {{ 'selected' if room_assignment and room_assignment.change_reason == 'guest_request' else '' }}>
        ğŸ‘¤ YÃªu cáº§u cá»§a khÃ¡ch
      </option>
      <option value="upgrade" {{ 'selected' if room_assignment and room_assignment.change_reason == 'upgrade' else '' }}>
        â¬†ï¸ Upgrade phÃ²ng
      </option>
      <option value="overbooking" {{ 'selected' if room_assignment and room_assignment.change_reason == 'overbooking' else '' }}>
        ğŸ“… Overbooking/xung Ä‘á»™t lá»‹ch
      </option>
      <option value="operational" {{ 'selected' if room_assignment and room_assignment.change_reason == 'operational' else '' }}>
        âš™ï¸ LÃ½ do váº­n hÃ nh
      </option>
      <option value="other" {{ 'selected' if room_assignment and room_assignment.change_reason == 'other' else '' }}>
        ğŸ“‹ KhÃ¡c
      </option>
    </select>
  </label>
  
  <label>NgÃ y thay Ä‘á»•i
    <input type="date" name="changed_date" 
           value="{{ room_assignment.changed_date if room_assignment and room_assignment.changed_date else booking.start_date }}">
    <small>NgÃ y xÃ¡c nháº­n/thá»±c hiá»‡n viá»‡c Ä‘á»•i phÃ²ng</small>
  </label>
  
  <label>NgÆ°á»i thá»±c hiá»‡n
    <input type="text" name="changed_by" 
           value="{{ room_assignment.changed_by if room_assignment else '' }}" 
           placeholder="TÃªn nhÃ¢n viÃªn">
    <small>Ai lÃ  ngÆ°á»i xá»­ lÃ½ viá»‡c Ä‘á»•i phÃ²ng</small>
  </label>
  
  <label>Ghi chÃº
    <textarea name="notes" rows="3" placeholder="MÃ´ táº£ chi tiáº¿t vá» viá»‡c Ä‘á»•i phÃ²ng...">{{ room_assignment.notes if room_assignment else '' }}</textarea>
  </label>
  
  <!-- Submit -->
  <div style="margin-top: 32px; padding-top: 16px; border-top: 1px solid #dee2e6;">
    <button type="submit" class="btn" style="margin-right: 8px;">
      {{ 'ğŸ’¾ Cáº­p nháº­t' if room_assignment else 'â• Táº¡o má»›i' }} Room Assignment
    </button>
    <a href="/bookings/{{ booking.id }}" class="btn" style="background: #6c757d;">âŒ Há»§y</a>
  </div>
  
</form>

<!-- Room Assignment Preview -->
{% if room_assignment %}
<div style="margin-top: 32px; background: #e3f2fd; padding: 16px; border-radius: 8px;">
  <h3>ğŸ” Preview phÃ¢n bá»• doanh thu</h3>
  <div id="revenue-preview">
    <!-- Will be populated by JavaScript or server-side -->
    <p><strong>Tá»•ng:</strong> {{ "{:,}".format(booking.total_payout_vnd or 0) }} VND</p>
    <p><strong>PhÃ²ng Ä‘Ã£ Ä‘áº·t (<span id="booked-room-name">{{ room_assignment.booked_room }}</span>):</strong> 
      <span id="booked-revenue">â€”</span> VND</p>
    <p><strong>PhÃ²ng thá»±c táº¿ (<span id="actual-room-name">{{ room_assignment.actual_room }}</span>):</strong> 
      <span id="actual-revenue">â€”</span> VND</p>
  </div>
</div>
{% endif %}

<script>
// Simple revenue attribution preview  
function updateRevenuePreview() {
  const attribution = document.querySelector('[name="revenue_attribution"]').value;
  const totalRevenue = parseInt('{{ booking.total_payout_vnd or 0 }}');
  const bookedSpan = document.getElementById('booked-revenue');
  const actualSpan = document.getElementById('actual-revenue');
  
  // Update room names in preview
  const bookedSelect = document.querySelector('[name="booked_room"]');
  const actualSelect = document.querySelector('[name="actual_room"]');
  const bookedNameSpan = document.getElementById('booked-room-name');
  const actualNameSpan = document.getElementById('actual-room-name');
  
  if (bookedSelect && bookedNameSpan) {
    const bookedOption = bookedSelect.options[bookedSelect.selectedIndex];
    bookedNameSpan.textContent = bookedOption.value || 'â€”';
  }
  
  if (actualSelect && actualNameSpan) {
    const actualOption = actualSelect.options[actualSelect.selectedIndex];
    actualNameSpan.textContent = actualOption.value || 'â€”';
  }
  
  if (!bookedSpan || !actualSpan) return;
  
  let bookedRevenue = 0;
  let actualRevenue = 0;
  
  if (attribution === 'booked_room') {
    bookedRevenue = totalRevenue;
  } else if (attribution === 'actual_room') {
    actualRevenue = totalRevenue;
  } else if (attribution === 'split') {
    bookedRevenue = Math.floor(totalRevenue / 2);
    actualRevenue = totalRevenue - bookedRevenue;
  }
  
  bookedSpan.textContent = bookedRevenue.toLocaleString();
  actualSpan.textContent = actualRevenue.toLocaleString();
}

// Update preview on page load and when selection changes
document.addEventListener('DOMContentLoaded', updateRevenuePreview);
const attributionSelect = document.querySelector('[name="revenue_attribution"]');
if (attributionSelect) {
  attributionSelect.addEventListener('change', updateRevenuePreview);
}

// Listen to room selection changes
const bookedRoomSelect = document.querySelector('[name="booked_room"]');
const actualRoomSelect = document.querySelector('[name="actual_room"]');
if (bookedRoomSelect) {
  bookedRoomSelect.addEventListener('change', updateRevenuePreview);
}
if (actualRoomSelect) {
  actualRoomSelect.addEventListener('change', updateRevenuePreview);
}
</script>

{% endblock %}